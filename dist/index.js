"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("worker_threads"),t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},r={exports:{}};!function(e){var r,n="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{};
/*! *****************************************************************************
	Copyright (C) Microsoft. All rights reserved.
	Licensed under the Apache License, Version 2.0 (the "License"); you may not use
	this file except in compliance with the License. You may obtain a copy of the
	License at http://www.apache.org/licenses/LICENSE-2.0

	THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
	KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
	WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
	MERCHANTABLITY OR NON-INFRINGEMENT.

	See the Apache Version 2.0 License for specific language governing permissions
	and limitations under the License.
	***************************************************************************** */!function(e){!function(t){var r="object"==typeof n?n:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),s=i(e);function i(e,t){return function(r,n){"function"!=typeof e[r]&&Object.defineProperty(e,r,{configurable:!0,writable:!0,value:n}),t&&t(r,n)}}void 0===r.Reflect?r.Reflect=e:s=i(r.Reflect,s),function(e){var t=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,n=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",s=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",i="function"==typeof Object.create,o={__proto__:[]}instanceof Array,a=!i&&!o,h={create:i?function(){return ne(Object.create(null))}:o?function(){return ne({__proto__:null})}:function(){return ne({})},has:a?function(e,r){return t.call(e,r)}:function(e,t){return t in e},get:a?function(e,r){return t.call(e,r)?e[r]:void 0}:function(e,t){return e[t]}},u=Object.getPrototypeOf(Function),c="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,f=c||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?ee():Map,l=c||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?te():Set,d=new(c||"function"!=typeof WeakMap?re():WeakMap);function p(e,t,r,n){if(A(r)){if(!L(e))throw new TypeError;if(!V(t))throw new TypeError;return x(e,t)}if(!L(e))throw new TypeError;if(!q(t))throw new TypeError;if(!q(n)&&!A(n)&&!$(n))throw new TypeError;return $(n)&&(n=void 0),M(e,t,r=D(r),n)}function y(e,t){function r(r,n){if(!q(r))throw new TypeError;if(!A(n)&&!K(n))throw new TypeError;R(e,t,r,n)}return r}function v(e,t,r,n){if(!q(r))throw new TypeError;return A(n)||(n=D(n)),R(e,t,r,n)}function m(e,t,r){if(!q(t))throw new TypeError;return A(r)||(r=D(r)),P(e,t,r)}function g(e,t,r){if(!q(t))throw new TypeError;return A(r)||(r=D(r)),I(e,t,r)}function w(e,t,r){if(!q(t))throw new TypeError;return A(r)||(r=D(r)),k(e,t,r)}function _(e,t,r){if(!q(t))throw new TypeError;return A(r)||(r=D(r)),C(e,t,r)}function E(e,t){if(!q(e))throw new TypeError;return A(t)||(t=D(t)),S(e,t)}function T(e,t){if(!q(e))throw new TypeError;return A(t)||(t=D(t)),N(e,t)}function b(e,t,r){if(!q(t))throw new TypeError;A(r)||(r=D(r));var n=O(t,r,!1);if(A(n))return!1;if(!n.delete(e))return!1;if(n.size>0)return!0;var s=d.get(t);return s.delete(r),s.size>0||d.delete(t),!0}function x(e,t){for(var r=e.length-1;r>=0;--r){var n=(0,e[r])(t);if(!A(n)&&!$(n)){if(!V(n))throw new TypeError;t=n}}return t}function M(e,t,r,n){for(var s=e.length-1;s>=0;--s){var i=(0,e[s])(t,r,n);if(!A(i)&&!$(i)){if(!q(i))throw new TypeError;n=i}}return n}function O(e,t,r){var n=d.get(e);if(A(n)){if(!r)return;n=new f,d.set(e,n)}var s=n.get(t);if(A(s)){if(!r)return;s=new f,n.set(t,s)}return s}function P(e,t,r){if(I(e,t,r))return!0;var n=Z(t);return!$(n)&&P(e,n,r)}function I(e,t,r){var n=O(t,r,!1);return!A(n)&&H(n.has(e))}function k(e,t,r){if(I(e,t,r))return C(e,t,r);var n=Z(t);return $(n)?void 0:k(e,n,r)}function C(e,t,r){var n=O(t,r,!1);if(!A(n))return n.get(e)}function R(e,t,r,n){O(r,n,!0).set(e,t)}function S(e,t){var r=N(e,t),n=Z(e);if(null===n)return r;var s=S(n,t);if(s.length<=0)return r;if(r.length<=0)return s;for(var i=new l,o=[],a=0,h=r;a<h.length;a++){var u=h[a];i.has(u)||(i.add(u),o.push(u))}for(var c=0,f=s;c<f.length;c++)u=f[c],i.has(u)||(i.add(u),o.push(u));return o}function N(e,t){var r=[],n=O(e,t,!1);if(A(n))return r;for(var s=Y(n.keys()),i=0;;){var o=J(s);if(!o)return r.length=i,r;var a=G(o);try{r[i]=a}catch(e){try{X(s)}finally{throw e}}i++}}function j(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function A(e){return void 0===e}function $(e){return null===e}function F(e){return"symbol"==typeof e}function q(e){return"object"==typeof e?null!==e:"function"==typeof e}function B(e,t){switch(j(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var r=3===t?"string":5===t?"number":"default",s=Q(e,n);if(void 0!==s){var i=s.call(e,r);if(q(i))throw new TypeError;return i}return z(e,"default"===r?"number":r)}function z(e,t){if("string"===t){var r=e.toString;if(W(r)&&!q(s=r.call(e)))return s;if(W(n=e.valueOf)&&!q(s=n.call(e)))return s}else{var n;if(W(n=e.valueOf)&&!q(s=n.call(e)))return s;var s,i=e.toString;if(W(i)&&!q(s=i.call(e)))return s}throw new TypeError}function H(e){return!!e}function U(e){return""+e}function D(e){var t=B(e,3);return F(t)?t:U(t)}function L(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function W(e){return"function"==typeof e}function V(e){return"function"==typeof e}function K(e){switch(j(e)){case 3:case 4:return!0;default:return!1}}function Q(e,t){var r=e[t];if(null!=r){if(!W(r))throw new TypeError;return r}}function Y(e){var t=Q(e,s);if(!W(t))throw new TypeError;var r=t.call(e);if(!q(r))throw new TypeError;return r}function G(e){return e.value}function J(e){var t=e.next();return!t.done&&t}function X(e){var t=e.return;t&&t.call(e)}function Z(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===u)return t;if(t!==u)return t;var r=e.prototype,n=r&&Object.getPrototypeOf(r);if(null==n||n===Object.prototype)return t;var s=n.constructor;return"function"!=typeof s||s===e?t:s}function ee(){var e={},t=[],r=function(){function e(e,t,r){this._index=0,this._keys=e,this._values=t,this._selector=r}return e.prototype["@@iterator"]=function(){return this},e.prototype[s]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var r=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:r,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var r=this._find(e,!0);return this._values[r]=t,this},t.prototype.delete=function(t){var r=this._find(t,!1);if(r>=0){for(var n=this._keys.length,s=r+1;s<n;s++)this._keys[s-1]=this._keys[s],this._values[s-1]=this._values[s];return this._keys.length--,this._values.length--,t===this._cacheKey&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new r(this._keys,this._values,n)},t.prototype.values=function(){return new r(this._keys,this._values,i)},t.prototype.entries=function(){return new r(this._keys,this._values,o)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[s]=function(){return this.entries()},t.prototype._find=function(e,t){return this._cacheKey!==e&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=e)),this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function n(e,t){return e}function i(e,t){return t}function o(e,t){return[e,t]}}function te(){return function(){function e(){this._map=new f}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.values()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[s]=function(){return this.keys()},e}()}function re(){var e=16,r=h.create(),n=s();return function(){function e(){this._key=s()}return e.prototype.has=function(e){var t=i(e,!1);return void 0!==t&&h.has(t,this._key)},e.prototype.get=function(e){var t=i(e,!1);return void 0!==t?h.get(t,this._key):void 0},e.prototype.set=function(e,t){return i(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=i(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=s()},e}();function s(){var e;do{e="@@WeakMap@@"+u()}while(h.has(r,e));return r[e]=!0,e}function i(e,r){if(!t.call(e,n)){if(!r)return;Object.defineProperty(e,n,{value:h.create()})}return e[n]}function o(e,t){for(var r=0;r<t;++r)e[r]=255*Math.random()|0;return e}function a(e){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(e)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(e)):o(new Uint8Array(e),e):o(new Array(e),e)}function u(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var r="",n=0;n<e;++n){var s=t[n];4!==n&&6!==n&&8!==n||(r+="-"),s<16&&(r+="0"),r+=s.toString(16).toLowerCase()}return r}}function ne(e){return e.__=void 0,delete e.__,e}e("decorate",p),e("metadata",y),e("defineMetadata",v),e("hasMetadata",m),e("hasOwnMetadata",g),e("getMetadata",w),e("getOwnMetadata",_),e("getMetadataKeys",E),e("getOwnMetadataKeys",T),e("deleteMetadata",b)}(s)}()}(r||(r={}));const s="undefined"!=typeof window?window:t,i=Symbol("byteshift-injector");void 0===s[i]&&(s[i]={d:new Map,i:new Map});const o=new class{register(e){s[i].d.set(e,e)}has(e){return s[i].d.has(e)}get(e){if(!this.has(e))throw console.error("The requested service does not exist:",e.name),new Error("Service does not exist.");return s[i].i.has(e)||s[i].i.set(e,new e),s[i].i.get(e)}};e.Inject=function(e,t){const r=Reflect.getMetadata("design:type",e,t);let n;Object.defineProperty(e,t,{configurable:!1,enumerable:!1,get:()=>{if(!n){if(!o.has(r))throw new Error(`The service requested by property "${t}" of "${e.name}" does not exist.`);n=o.get(r)}return n}})},e.InjectDirect=function(e,t){const r=Reflect.getMetadata("design:type",e,t);if(!o.has(r))throw new Error(`The service requested by property "${t}" of "${e.name}" does not exist.`);e[t]=o.get(r)},e.Service=function(e){o.register(e)},e.ServiceHost=o,Object.defineProperty(e,"__esModule",{value:!0})}(r.exports);var n,s={exports:{}};function i(e,t){const r={};for(const n of(e=>{let t=[],r=e;do{t=t.concat(Object.getOwnPropertyNames(r)),r=Object.getPrototypeOf(r)}while(r);return t.sort().filter(((t,r,n)=>{if(!1===t.startsWith("__")&&-1===["arguments","caller","callee","constructor","hasOwnProperty","isPrototypeOf","main","propertyIsEnumerable","toLocaleString","toString","valueOf"].indexOf(t)&&t!==n[r+1]&&"function"==typeof e[t])return!0}))})(e.prototype))r[n]=async(...e)=>await t(n,e);return r}!function(e){class t{constructor(e,t,r,n=!1){this.emitter=e,this.name=t,this.callback=r,this.isOnce=n}emit(...e){this.callback(...e),this.isOnce&&this.emitter.off(this)}unsubscribe(){this.emitter.off(this)}}e.EventEmitter=class{constructor(){this._events=new Map,this._emitted=new Set}once(e,t){return this.on(e,t,!0)}on(e,r,n){this._events.has(e)||this._events.set(e,new Set);const s=new t(this,e,r,n);return this._events.get(e).add(s),s}off(e){this._events.has(e.name)&&this._events.get(e.name).delete(e)}emit(e,...t){if("*"===e)throw new Error('Event "*" cannot be emitted.');this._events.has("*")&&this._events.get("*").forEach((r=>r.emit(e,...t))),this._events.has(e)?(this._events.get(e).forEach((e=>e.emit(...t))),this._emitted.add(e)):this._emitted.add(e)}async when(e){return this._emitted.has(e)?Promise.resolve():new Promise((t=>{this.once(e,(()=>t()))}))}},e.EventSubscriber=t,Object.defineProperty(e,"__esModule",{value:!0})}(s.exports),function(e){e[e.INIT=0]="INIT",e[e.READY=1]="READY",e[e.CREATE_PORT=2]="CREATE_PORT",e[e.CONNECT_PORT=3]="CONNECT_PORT",e[e.REQUEST=4]="REQUEST",e[e.RESPONSE=5]="RESPONSE",e[e.EVENT=6]="EVENT",e[e.LOG=7]="LOG"}(n||(n={}));class o extends s.exports.EventEmitter{worker;svcId;port;proxy={};queue=new Map;pass=[];constructor(t,r=null){super(),this.worker=r,this.svcId=t.name,this.proxy=i(t,((e,t)=>this.runMethod(e,t))),e.isMainThread?this.worker&&this.handleResponseEventFrom(r):this.handleResponseEventFrom(e.parentPort)}transferObject(e){this.pass.push(e)}get delegate(){return this.proxy}on(t,r,n){return e.isMainThread||this.port||this.createPort().then((()=>{})),super.on(t,r,n)}async runMethod(t,r){return e.isMainThread?new Promise((e=>{const s=this.generateFreeMessageId();this.queue.set(s,e),this.worker.postMessage({type:n.REQUEST,mId:s,name:t,args:r},this.pass),this.pass=[]})):(void 0===this.port&&await this.createPort(),new Promise((e=>{const s=this.generateFreeMessageId();this.queue.set(s,e),this.port.postMessage({type:n.REQUEST,mId:s,name:t,args:r},this.pass),this.pass=[]})))}async createPort(){return new Promise((t=>{const r=this.generateFreeMessageId();this.queue.set(r,(e=>{this.port=e,this.handleResponseEventFrom(e),t()})),e.parentPort.postMessage({type:n.CREATE_PORT,mId:r,data:{svcId:this.svcId}})}))}handleResponseEventFrom(e){e.setMaxListeners(256),e.on("message",(e=>{switch(e.type){case n.RESPONSE:return void(this.queue.has(e.mId)&&(this.queue.get(e.mId)(e.result),this.queue.delete(e.mId)));case n.EVENT:return void this.emit(e.eventName,e.eventData)}}))}generateFreeMessageId(){const e=Math.floor(2147483646*Math.random());return this.queue.has(e)?this.generateFreeMessageId():e}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function a(e,t,r,n){var s,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,r,o):s(t,r))||o);return i>3&&o&&Object.defineProperty(t,r,o),o}class h extends s.exports.EventEmitter{host;serviceClass;threadCount;onBusyCallback;bootstrapFile;exitCleanlyOnThreadCrash;threads=new Map;proxy;constructor(e,t,r,n,s,o=!1){super(),this.host=e,this.serviceClass=t,this.threadCount=r,this.onBusyCallback=n,this.bootstrapFile=s,this.exitCleanlyOnThreadCrash=o,this.proxy=i(t,((e,t)=>this.runMethod(e,t)))}onBusy(e){this.onBusyCallback=e}get hasIdleThreads(){for(const e of this.threads.values())if(!e.isBusy)return!0;return!1}get busyThreadCount(){let e=0;for(const t of this.threads.values())t.isBusy&&e++;return e}get isStarted(){for(let e of this.threads.values())if(!e.isRunning)return!1;return!0}get delegate(){return this.proxy}get service(){return this.serviceClass}start(){let e,t=0;return this.on("childOnline",(()=>{t++,t===this.threadCount&&e()})),new Promise((t=>{e=t;for(let e=0;e<this.threadCount;e++)this.threads.set(e+1,this.spawnThread(e+1))}))}spawnThread(t){const r=new e.Worker(this.bootstrapFile,{env:e.SHARE_ENV}),s=new o(this.serviceClass,r);this.configureMultiThreadCommunicationEvents(r);const i={id:t,worker:r,thread:s,isRunning:!1,isBusy:!1,queue:new Set};return r.on("error",(e=>{this.emit("log",{level:"emergency",message:`Thread "${this.serviceClass.name}" crashed. Error: ${e.message}. Trace: ${e.stack}`}),setTimeout((()=>{process.exit(this.exitCleanlyOnThreadCrash?0:1)}),1e3)})),r.on("online",(()=>{this.emit("log",{level:"debug",message:`Service thread #${r.threadId} "${this.serviceClass.name}" is online.`}),this.host.emit("add",{thread:s,worker:r,service:this.serviceClass})})),r.on("exit",(()=>{this.emit("log",{level:"warning",message:`Service thread "${this.serviceClass.name}" is terminated.`})})),r.postMessage({type:n.INIT,svc:this.serviceClass.name,poolId:t}),s.once("__running__",(async()=>{this.emit("log",{level:"debug",message:`Service thread #${r.threadId} "${this.serviceClass.name}" is successfully initialized.`}),i.isRunning=!0,this.emit("childOnline",i)})),i}async runMethod(e,t){const r=this.findFreeThread();return r.isBusy&&"function"==typeof this.onBusyCallback?this.onBusyCallback():new Promise((n=>{r.queue.add(n),r.isBusy=!0,this.emit("tick"),r.thread.delegate[e](...t).then((e=>{r.queue.delete(n),r.isBusy=!1,n(e),this.emit("tick")})).catch((e=>{console.error(e)}))}))}findFreeThread(){let e,t=1/0;for(let r of this.threads.values()){if(!r.isBusy)return r;t>r.queue.size&&(t=r.queue.size,e=r)}return e}configureMultiThreadCommunicationEvents(t){t.on("message",(async r=>{if(r.type!==n.CREATE_PORT)return;const{port1:s,port2:i}=new e.MessageChannel;(await this.host.getWorkerByName(r.data.svcId)).postMessage({type:n.CONNECT_PORT,port:i},[i]),t.postMessage({type:n.RESPONSE,mId:r.mId,poolId:r.poolId||void 0,result:s},[s])}))}}exports.ThreadHost=class extends s.exports.EventEmitter{exitCleanlyOnThreadCrash=!1;bootstrapFile=null;services=new Map;pools=new Map;initialize(e,t=!1){this.bootstrapFile=e,this.exitCleanlyOnThreadCrash=t}register(...e){if(!this.bootstrapFile)throw new Error("Unable to register a threadable class without initializing the ThreadHost first. Please call .initialize() first.");e.forEach((e=>{if(this.services.has(e.name))throw new Error(`Another threaded service with the name "${e.name}" is already registered.`);this.services.set(e.name,{service:e,thread:null,worker:null})}))}registerPool(e,t,r){if(!this.bootstrapFile)throw new Error("Unable to register a thread pool without initializing the ThreadHost first. Please call .initialize() first.");if(this.pools.has(e.name))throw new Error(`Another thread pool already exists for service class "${e.name}".`);this.pools.set(e.name,new h(this,e,t,r,this.bootstrapFile,this.exitCleanlyOnThreadCrash))}get(t){if(!e.isMainThread)throw new Error("A child thread can only be retrieved from the main thread.");if(!1===this.services.has(t.name))throw new Error(`Thread "${t.name}" does not exist or is not registered.`);if(!this.services.get(t.name).thread)throw new Error(`Unable to retrieve thread "${t.name}" because it is not started.`);return this.services.get(t.name).thread}getPool(t){if(!e.isMainThread)throw new Error("A thread pool can only be retrieved from the main thread.");if(!1===this.pools.has(t.name))throw new Error(`A thread pool for "${t.name}" does not exist or is not registered.`);const r=this.pools.get(t.name);if(!1===r.isStarted)throw new Error(`Thread pool for service "${t.name}" has not been started.`);return r}async start(...t){if(!e.isMainThread)throw new Error("A thread can only be started from the main thread.");for(let e of t)await this._start(e)}async startPool(...t){if(!e.isMainThread)throw new Error("A thread pool can only be started from the main thread.");for(let e of t){if(!this.pools.has(e.name))throw new Error(`There is no thread pool for service class "${e.name}".`);await this.pools.get(e.name).start()}}_start(t){const r=this.bootstrapFile;return new Promise((s=>{const i=new e.Worker(r,{env:e.SHARE_ENV}),a=new o(t,i);i.on("error",(e=>{this.emit("log",{level:"emergency",message:`Thread "${t.name}" crashed. Error: ${e.message}. Trace: ${e.stack}`}),setTimeout((()=>{process.exit(this.exitCleanlyOnThreadCrash?1:0)}),1e3)})),i.on("online",(()=>{this.emit("log",{level:"debug",message:`Service thread #${i.threadId} "${t.name}" is online.`}),this.emit("add",this.services.get(t.name))})),i.on("exit",(()=>{this.emit("log",{level:"warning",message:`Service thread "${t.name}" is terminated.`}),this.emit("remove",this.services.get(t.name))})),this.configureMultiThreadCommunicationEvents(i),this.services.get(t.name).thread=a,this.services.get(t.name).worker=i,i.postMessage({type:n.INIT,svc:t.name}),a.once("__running__",(async()=>{this.emit("log",{level:"debug",message:`Service thread #${i.threadId} "${t.name}" is successfully initialized.`}),s(a)}))}))}getWorkerByName(t){if(!e.isMainThread)throw new Error(`A child thread attempted to fetch the worker for service "${t}" directly.`);const r=this.services.get(t);if(!r)throw new Error(`The worker for "${t}" is offline.`);return r.worker}getClass(e){if(!1===this.services.has(e)){if(!1===this.pools.has(e))throw new Error(`Threadable service "${e}" does not exist.`);return this.pools.get(e).service}return this.services.get(e).service}configureMultiThreadCommunicationEvents(t){t.on("message",(async r=>{if(r.type!==n.CREATE_PORT)return;const{port1:s,port2:i}=new e.MessageChannel;(await this.getWorkerByName(r.data.svcId)).postMessage({type:n.CONNECT_PORT,port:i},[i]),t.postMessage({type:n.RESPONSE,mId:r.mId,poolId:r.poolId||void 0,result:s},[s])}))}},exports.ThreadHost=a([r.exports.Service],exports.ThreadHost);class u extends s.exports.EventEmitter{async ping(){return"pong"}}class c{host;serviceId="N/A";poolId=null;queue=new Map;service;async run(){if(!0===e.isMainThread)throw new Error("this.run cannot be executed from the main thread.");e.parentPort.on("message",(async t=>{switch(t.type){case n.INIT:return this.serviceId=t.svc,this.service=new(this.host.getClass(t.svc)),this.poolId=t.poolId||void 0,e.parentPort.setMaxListeners(256),this.handleRequestMessagesFromPort(e.parentPort),await this.service.__init__(),void e.parentPort.postMessage({type:n.EVENT,eventName:"__running__",eventData:null});case n.RESPONSE:if(!this.queue.has(t.mId))return;return this.queue.get(t.mId)(t.data),void this.queue.delete(t.mId);case n.CONNECT_PORT:return t.port.setMaxListeners(256),void this.handleRequestMessagesFromPort(t.port)}}))}handleRequestMessagesFromPort(e){e.on("message",(async t=>{t.type===n.REQUEST&&("function"==typeof this.service[t.name]?e.postMessage({type:n.RESPONSE,mId:t.mId,poolId:this.poolId,result:await this.service[t.name](...t.args)}):console.warn(`Method ${t.name} does not exist in thread "${this.serviceId}".`))})),this.service instanceof s.exports.EventEmitter&&this.service.on("*",((t,r)=>{e.postMessage({type:n.EVENT,eventName:t,eventData:r})}))}}a([r.exports.Inject,function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:type",exports.ThreadHost)],c.prototype,"host",void 0),exports.Delegate=function(t){return function(n,s){let i;Object.defineProperty(n,s,{configurable:!1,enumerable:!1,get:()=>(i||(i=e.isMainThread?new o(t,r.exports.ServiceHost.get(exports.ThreadHost).getWorkerByName(t.name)):new o(t)),i)})}},exports.DelegatePool=function(t){return function(n,s){Object.defineProperty(n,s,{configurable:!1,enumerable:!1,get:()=>{if(!e.isMainThread)throw new Error("A thread pool can only be accessed from the main thread.");return r.exports.ServiceHost.get(exports.ThreadHost).getPool(t)}})}},exports.Thread=u,exports.ThreadContext=c,exports.ThreadDelegate=o,exports.ThreadPool=h;
//# sourceMappingURL=index.js.map
